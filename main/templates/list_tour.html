<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
@media print {
    body * {
        visibility: hidden;
    }
    .print-section, .print-section * {
        visibility: visible;
    }
    .print-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}
</style>

<div class="container my-4">
    <h3>Saved Tour Programs</h3>
    <a href="{% url 'main:add_tour_program' %}" class="btn btn-primary mb-3">Add New Tour</a>

    <form id="print-form">
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Programs</th>
                        <th>Hotels</th>
                        <th>Drivers</th>
                        <th>Cars</th>
                        <th>Guides</th>
                        <th>Flights</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for program in programs %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_tours" value="{{ program.id }}">
                            </td>
                            <td>{{ program.id }}</td>
                            <td>{{ program.date }}</td>
                            <td>{{ program.program_options.all|join:", " }}</td>
                            <td>{{ program.hotel_options.all|join:", " }}</td>
                            <td>{{ program.driver_options.all|join:", " }}</td>
                            <td>{{ program.car_options.all|join:", " }}</td>
                            <td>{{ program.guide_options.all|join:", " }}</td>
                            <td>{{ program.flight_options.all|join:", " }}</td>
                            <td>{{ program.notes }}</td>
                        </tr>

                        <!-- Hidden Print Section for This Tour -->
                        <div id="tour-{{ program.id }}" class="print-section" style="display: none;">
                            <h2>Tour Program #{{ program.id }}</h2>
                            <p><strong>Date:</strong> {{ program.date }}</p>
                            <p><strong>Programs:</strong> {{ program.program_options.all|join:", " }}</p>
                            <p><strong>Hotels:</strong> {{ program.hotel_options.all|join:", " }}</p>
                            <p><strong>Drivers:</strong> {{ program.driver_options.all|join:", " }}</p>
                            <p><strong>Cars:</strong> {{ program.car_options.all|join:", " }}</p>
                            <p><strong>Guides:</strong> {{ program.guide_options.all|join:", " }}</p>
                            <p><strong>Flights:</strong> {{ program.flight_options.all|join:", " }}</p>
                            <p><strong>Notes:</strong> {{ program.notes }}</p>
                            <hr>
                        </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-success mt-3" onclick="printSelected()">üñ®Ô∏è Print Selected</button>
    </form>
</div>

<script>
function printSelected() {
    const selected = document.querySelectorAll('input[name="selected_tours"]:checked');
    if (selected.length === 0) {
        alert("Please select at least one tour to print.");
        return;
    }

    // Collect content of selected tours
    let printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>Selected Tours</title>');
    printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">');
    printWindow.document.write('</head><body>');

    selected.forEach(item => {
        const section = document.getElementById(`tour-${item.value}`);
        if (section) {
            printWindow.document.write(section.innerHTML);
            printWindow.document.write('<hr>');
        }
    });

    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
</script>
